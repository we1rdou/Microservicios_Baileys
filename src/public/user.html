<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Usuario - WhatsApp</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <link rel="stylesheet" href="./css/style.css">

</head>
<body>
  <h2>Bienvenido, <span id="nombreUsuario">...</span></h2>
  <button id="logoutBtn">Cerrar sesi√≥n</button>
  <div id="estadoConexion">Estado: verificando...</div>
  <div id="qr" class="hidden">Cargando QR...</div>
  <div id="alerta" class="hidden"></div>
  <button id="recargarQRBtn" class="hidden">Haz clic para recargar el c√≥digo QR</button>

  <script>
    let sessionId = null;
    let intervaloEstado = null;
    let ultimoEstado = null;
    let qrTimeout = null;
    let qrRefreshInterval = null;
    let ultimoQR = '';

    fetch('/api/me')
      .then(res => {
        if (!res.ok) throw new Error('No autorizado');
        return res.json();
      })
      .then(async user => {
        if (user.role !== 'user') {
          alert('Acceso denegado.');
          return location.href = '/';
        }

        sessionId = user.username;
        document.getElementById('nombreUsuario').textContent = sessionId;

        const estado = await obtenerEstado(sessionId);

        if (estado.connectionState === 'connected') {
          document.getElementById('estadoConexion').innerText = 'Estado: ¬°Sesi√≥n conectada!';
          document.getElementById('qr').classList.add('hidden');
          return;
        }

        await iniciarSesion(sessionId);
        cargarQR(sessionId);
        verificarEstadoSesion();
        intervaloEstado = setInterval(verificarEstadoSesion, 2000);
      })
      .catch(() => {
        alert('Necesitas iniciar sesi√≥n.');
        window.location.href = '/';
      });

    async function obtenerEstado(sessionId) {
      try {
        const res = await fetch(`/api/status/${sessionId}`);
        if (!res.ok) throw new Error();
        return await res.json();
      } catch {
        return { connectionState: 'unknown' };
      }
    }

    async function iniciarSesion(sessionId) {
      try {
        const res = await fetch(`/api/init-session/${sessionId}`, { method: 'POST' });
        if (!res.ok) throw new Error();
      } catch (err) {
        console.error(err);
        document.getElementById('qr').classList.remove('hidden');
        document.getElementById('qr').textContent = 'Error al conectar con WhatsApp';
      }
    }

    function cargarQR(sessionId, intentos = 0) {
      fetch(`/api/qr/${sessionId}`)
        .then(res => {
          if (!res.ok) throw new Error('QR no disponible');
          return res.json();
        })
        .then(data => {
          if (data.qr !== ultimoQR) {
            ultimoQR = data.qr;
            const qrDiv = document.getElementById('qr');
            const recargarBtn = document.getElementById('recargarQRBtn');
            qrDiv.innerHTML = '';
            recargarBtn.classList.add('hidden');

            const img = document.createElement('img');
            img.src = data.qr;
            img.alt = 'C√≥digo QR de WhatsApp';
            img.width = 250;
            qrDiv.appendChild(img);
            qrDiv.classList.remove('hidden');
            console.log('üîÑ Nuevo QR actualizado en pantalla');
          } else {
            console.log('‚è≥ QR sin cambios');
          }

          // Reset temporizador si se renderiza por primera vez
          if (!qrTimeout) {
            qrTimeout = setTimeout(() => {
              const qrDiv = document.getElementById('qr');
              const recargarBtn = document.getElementById('recargarQRBtn');
              qrDiv.classList.add('hidden');
              qrDiv.innerHTML = '';
              recargarBtn.classList.remove('hidden');
              console.warn('‚åõ QR expirado. Mostrar bot√≥n de recarga.');

              // Detener el polling
              clearInterval(qrRefreshInterval);
              qrRefreshInterval = null;
              ultimoQR = '';
              qrTimeout = null;
              // üî¥ Llamar al backend para detener generaci√≥n del QR
              fetch(`/api/stop-qr/${sessionId}`, { method: 'POST' });
            }, 120000); // 2 minutos
          }

          // Iniciar polling si no est√° activo
          if (!qrRefreshInterval) {
            qrRefreshInterval = setInterval(() => {
              cargarQR(sessionId);
            }, 10000); // Consulta cada 10s
          }
        })
        .catch(err => {
          console.warn('‚ö†Ô∏è QR no disponible:', err.message);
          if (intentos < 10) {
            setTimeout(() => cargarQR(sessionId, intentos + 1), 1500);
          } else {
            document.getElementById('qr').innerText = 'No se pudo obtener el QR';
          }
        });
    }


    async function verificarEstadoSesion() {
      try {
        const estado = await obtenerEstado(sessionId);

        const texto = {
          connected: '¬°Sesi√≥n conectada!',
          connecting: 'Conectando...',
          waiting_qr: 'Esperando escaneo del QR...',
          disconnected: 'Desconectado'
        };

        let mensaje = `Estado: ${texto[estado.connectionState] || 'Desconocido'}`;

      if (estado.mensaje) {
        mensaje += ` (${estado.mensaje})`;
        mostrarAlerta(estado.mensaje);

        // Mostrar alerta emergente solo si es la primera vez que aparece
        if (!window.__mensajeMostrado || window.__mensajeMostrado !== estado.mensaje) {
          alert(estado.mensaje);
          window.__mensajeMostrado = estado.mensaje;
        }
      } else {
        ocultarAlerta();
        window.__mensajeMostrado = null; // Reinicia el mensaje mostrado si se borra
      }


        document.getElementById('estadoConexion').innerText = mensaje;

        if (estado.connectionState === 'connected') {
          clearInterval(intervaloEstado);
          document.getElementById('qr').classList.add('hidden');
        } else if (estado.connectionState === 'waiting_qr' && ultimoEstado !== 'waiting_qr') {
          cargarQR(sessionId);
        }
        ultimoEstado = estado.connectionState;

      } catch (err) {
        console.warn('No se pudo verificar estado:', err);
        document.getElementById('estadoConexion').innerText = 'Estado: error';
      }
    }

    function mostrarAlerta(mensaje) {
      const alerta = document.getElementById('alerta');
      alerta.textContent = mensaje;
      alerta.classList.remove('hidden');
    }

    function ocultarAlerta() {
      const alerta = document.getElementById('alerta');
      alerta.textContent = '';
      alerta.classList.add('hidden');
    }

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      if (sessionId) {
        await fetch(`/api/logout/${sessionId}`, { method: 'POST' });
      }
      window.location.href = '/';
    });

    document.getElementById('recargarQRBtn').addEventListener('click', async () => {
  const recargarBtn = document.getElementById('recargarQRBtn');
  recargarBtn.classList.add('hidden');

  try {
    await fetch(`/api/init-session/${sessionId}`, { method: 'POST' });
    cargarQR(sessionId); // Reinicia QR
    verificarEstadoSesion(); // Opcionalmente refresca estado
    console.log('üîÑ Sesi√≥n reiniciada, nuevo QR solicitado.');
  } catch (err) {
    console.error('‚ùå Error al reiniciar sesi√≥n:', err);
    recargarBtn.classList.remove('hidden');
  }
});

  </script>
</body>
</html>
